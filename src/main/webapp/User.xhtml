<ui:composition template="templates/template_site.xhtml" 
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:menu="http://java.sun.com/jsf/composite/components/menu">
	
	<ui:param name="headline" value="User Page"/>
	<ui:param name="currentMainMenu" value="admin"/>
	
	<ui:define name="actionsMenu">
		<menu:context_actionMenu isUserLoggedIn="#{Auth.loggedIn}" 
								 curMainMenu="#{currentMainMenu}" 
								 downloadEnabled="false"
								 actionEnabled="false"
								 navBean="#{Navigation}"  />
	</ui:define>
	
	<ui:define name="mainContent">
		<h:outputText value="#{UserBean.init}"/>
		
		<!-- Breadcrumb - History -->
		<ui:include src="include/History.xhtml"></ui:include>
		
		<ui:fragment rendered="#{Auth.admin(UserBean.user)}">
			<h:panelGroup layout="block" styleClass="imj_backPanel" rendered="#{Auth.admin}">
				<a href="#{Navigation.applicationUrl}users" title="#{lbl.admin_user_view}">
					<h:outputText value="#{lbl.admin_user_view}" styleClass="imj_backButton" />
				</a>
			</h:panelGroup>
		
			<div class="imj_userConfig">
				
				<!-- Admin - TiledList -->
				<div class="imj_administrationTiledList imj_maxWidth">
				
					<div class="imj_listBody">			
		
						<h:panelGroup layout="block" styleClass="imj_adminPanel imj_userConfig">
						
							<div class="imj_headline">
								<h2><h:outputText value="#{headline} - #{UserBean.user.name}"/></h2>
							</div>
							
							<div class="imj_content">
								
								<h:form id ="userForm">
									<h:panelGroup layout="block" id="userInfos" class="imj_userGlobalInformation">					
										<fieldset>
											<!-- User Edit - Email -->
											<h:panelGroup layout="block" styleClass="imj_admindataSet">
												<div class="imj_admindataLabel">
													<h:outputText value="#{lbl.email}"/>
													<span class="imj_invisible">: </span>
												</div>
												<div class="imj_admindataValue">
													<h:panelGroup class="imj_admindataValueEntry" rendered="#{!UserBean.edit}">
														<h:outputText value="#{UserBean.user.email}"/>
													</h:panelGroup>
													<h:panelGroup class="imj_admindataSetEdit" rendered="#{UserBean.edit}" >
														<h:inputText value="#{UserBean.newEmail}" valueChangeListener="#{UserBean.changeEmailListener}" title="#{!Auth.admin ? msg.edit_user_email_forbidden : ''}" styleClass="imj_admindataEdit #{!Auth.admin ? 'imj_disabled' : ''}" disabled="#{!Auth.admin}" readonly="#{!Auth.admin}"/>
													</h:panelGroup>
												</div>
											</h:panelGroup>
											
											<!-- User Edit - Username -->
											<h:panelGroup layout="block" styleClass="imj_admindataSet" rendered="#{!UserBean.edit}">
												<div class="imj_admindataLabel">
													<h:outputText value="#{lbl.complete_name}"/>
													<span class="imj_invisible">: </span>
												</div>
												<div class="imj_admindataValue">
													<h:panelGroup class="imj_admindataValueEntry" >
														<h:outputText value="#{UserBean.user.name}" />
													</h:panelGroup>
												</div>
											</h:panelGroup>
											
											<h:panelGroup layout="block" styleClass="imj_admindataSet" rendered="#{UserBean.edit}">
												<div class="imj_admindataLabel">
													<h:outputText value="#{lbl.family_name}"/>
													<span class="imj_invisible">: </span>
												</div>
												<div class="imj_admindataValue">
													<h:panelGroup class="imj_admindataSetEdit" >
														<h:inputText value="#{UserBean.newFamilyName}" valueChangeListener="#{UserBean.changeFamilyNameListerner}" styleClass="imj_admindataEdit"/>
													</h:panelGroup>
												</div>
											</h:panelGroup>
											
											<h:panelGroup layout="block" styleClass="imj_admindataSet" rendered="#{UserBean.edit}">
												<div class="imj_admindataLabel">
													<h:outputText value="#{lbl.first_name}"/>
													<span class="imj_invisible">: </span>
												</div>
												<div class="imj_admindataValue">
													<h:panelGroup class="imj_admindataSetEdit" >
														<h:inputText value="#{UserBean.user.person.givenName}" styleClass="imj_admindataEdit"/>
													</h:panelGroup>
												</div>
											</h:panelGroup>
											
											<h:panelGroup layout="block" styleClass="imj_admindataSet">
												<div class="imj_admindataLabel">
													<h:outputText value="#{lbl.organization}"/>
													<span class="imj_invisible">: </span>
												</div>
												<div class="imj_admindataValue">
													<h:panelGroup class="imj_admindataValueEntry" rendered="#{!UserBean.edit}">
														<ui:repeat var="org" value="#{UserBean.user.person.organizations}"  varStatus="index" >
															<h:outputText value=", " rendered="#{index.index > 0}"/>
															<h:outputText value="#{org.name}"/>
														</ui:repeat>
													</h:panelGroup>
													<ui:repeat var="org" value="#{UserBean.user.person.organizations}" varStatus="index" >
														<h:panelGroup class="imj_admindataSetEdit" rendered="#{UserBean.edit}">
															<h:inputText value="#{org.name}"  styleClass="imj_admindataEdit "/>
															<span class="imj_inlineButtonGroup">
																<h:commandButton styleClass="imj_buttonAdd_16" type="submit" title="#{lbl.add_organization}" action="#{UserBean.addOrganization(index.index + 1)}">
																	<f:ajax execute="@form" render="@form"/>
																</h:commandButton>
																<h:commandButton styleClass="imj_buttonRemove_16 imj_admindataEdit imj_noDisplay" type="submit" title="#{lbl.remove_organization}" action="#{UserBean.removeOrganization(index.index)}">
																	<f:ajax execute="@form" render="@form"/>
																</h:commandButton>
															</span>
														</h:panelGroup>
													</ui:repeat>
												</div>
											</h:panelGroup>
											
											<!-- User Edit - Nickname -->
											<ui:fragment rendered="false">
												<h:panelGroup layout="block" styleClass="imj_admindataSet">
													<div class="imj_admindataLabel">
														<h:outputText value="#{lbl.nickname}"/>
														<span class="imj_invisible">: </span>
													</div>
													<div class="imj_admindataValue">
														<div class="imj_admindataValueEntry">
															<h:outputText value="#{UserBean.user.nick}"/>
														</div>
														<div class="imj_admindataSetEdit">
															<h:inputText value="#{UserBean.user.nick}" styleClass="imj_admindataEdit imj_noDisplay"/>
														</div>
													</div>
												</h:panelGroup>
											</ui:fragment>
											
											
											<!-- submit panel -->
											<div class="imj_submitPanel">
												<h:commandLink id="lnkEditUserdata" action="#{UserBean.toggleEdit}" value="#{lbl.edit}" rendered="#{!UserBean.edit}" styleClass="imj_editButton" type="submit">
													<f:ajax execute="@form" render="@form"/>
												</h:commandLink>
												<h:outputLink id="lnkCancelUserdata" value="" rendered="#{UserBean.edit}" styleClass="imj_cancelButton" type="submit">
													<h:outputText value="#{lbl.cancel}"/>
												</h:outputLink>
												<h:commandLink action="#{UserBean.updateUser}" value="#{lbl.save}" styleClass="imj_submitButton"  rendered="#{UserBean.edit}" type="submit"/>
											</div>
										</fieldset>
									</h:panelGroup> <!-- END user infos -->
									
									<!-- User Edit - Password -->
									<div class="imj_admindataSetEdit">
										<div class="imj_admindataSetEdit">
											<div class="imj_admindataLabel">
												<h:outputLabel for="inputPassword" value="#{lbl.password_new}"/>
												<span class="imj_invisible">: </span>
											</div>
											<div class="imj_admindataValue">
												<div class="imj_admindataValueEntry">
													<h:inputSecret id="inputPassword" value="#{UserBean.newPassword}" styleClass="imj_admindataEdit"/>
												</div>
											</div>
										</div>
										<div class="imj_admindataSetEdit">
											<div class="imj_admindataLabel">
												<h:outputLabel for="inputRespeated" value="#{lbl.password_repeat}"/>
												<span class="imj_invisible">: </span>
											</div>
											<div class="imj_admindataValue">
												<div class="imj_admindataValueEntry">
													<h:inputSecret id="inputRespeated" value="#{UserBean.repeatedPassword}" styleClass="imj_admindataEdit"/>
												</div>
												<h:commandButton action="#{UserBean.changePassword}" value="#{lbl.password_change}" styleClass="imj_editButton" type="submit">
													<f:ajax execute="@form" render="@none" />
												</h:commandButton>
											</div>
										</div>
									</div>
								</h:form>						
								<h:form id="grantForm">	
									<!-- User Grants -->
									<h:panelGroup layout="block" styleClass="imj_admindataSetEdit">
										<div class="imj_admindataLabel">
											<h:outputText value="#{UserBean.user.name} #{lbl.grants_has_following}:"/>
										</div>
										<div class="imj_admindataValue">
											<div class="imj_admindataValueEntry">
												<ui:fragment rendered="#{Auth.admin}">
													<div>
														<h:selectBooleanCheckbox value="#{UserBean.user.allowedToCreateCollection}" readonly="true" styleClass="imj_admindataCheckbox" onchange="document.getElementById('grantForm:toggleCreate').click()"/>
														<h:outputText value="#{lbl.allowedToCreateCollection}"/>
														<span class="imj_invisible">: </span>
													</div>
													<div>
														<h:selectBooleanCheckbox title="#{UserBean.user.admin and UserBean.uniqueAdmin ? lbl.user_unique_admin : lbl.user_toggle_admin_role}" value="#{UserBean.user.admin}" styleClass="imj_admindataCheckbox"  onchange="document.getElementById('grantForm:toggleAdmin').click();" disabled="#{UserBean.user.admin and UserBean.uniqueAdmin}"/>
														<h:outputText value="#{lbl.isAdmin}"/>
														<span class="imj_invisible">: </span>
													</div>
													<br/>
												</ui:fragment>
												<ui:repeat var="sh" value="#{UserBean.roles}" rows="0">
													<ui:param name="roles" value="#{sh.type == 'COLLECTION' ? SessionBean.shareCollectionGrantItems : SessionBean.shareAlbumGrantItems}"/>
													<ui:param name="roles" value="#{sh.type == 'ITEM' ? SessionBean.shareItemGrantItems : roles}"/>
													<div>
														<h:outputText value="Grant for #{sh.title}" styleClass="imj_admindataValueEntry"/>
														<h:commandButton action="#{UserBean.revokeGrants(sh)}" value="#{lbl.revoke}" styleClass="imj_cancelButton" onclick="if(confirm('Are you sure you want to revoke this grant?'))return true;return false;" type="submit"/>
														<h:selectManyCheckbox id="role" value="#{sh.sharedType}"  disabled="true" layout="pageDirection">
															<f:selectItems value="#{roles}" />
														</h:selectManyCheckbox>
													</div>
													<br/>
												</ui:repeat>
												<h:commandButton id="toggleCreate" action="#{UserBean.toggleCreateCollection}" value="toggle create col" styleClass="imj_noDisplay" type="submit">
													<f:ajax render="@none"/>
												</h:commandButton>
												<h:commandButton id="toggleAdmin" action="#{UserBean.toggleAdmin}" value="toggle admin" styleClass="imj_noDisplay" type="submit">
													<f:ajax render="@form"/>
												</h:commandButton>
											</div>
										</div>
									</h:panelGroup>											
								</h:form>
								<h:form id="userGroups">
									<!-- usergroups -->
									<h:panelGroup layout="block" styleClass="imj_admindataSetEdit">
										<div class="imj_admindataLabel">
											<h:outputText value="#{UserBean.user.name} #{lbl.in_following_user_groups}:"/>
										</div>
										<div class="imj_admindataValue">
											<div class="imj_admindataValueEntry">
												<ui:repeat var="ug" value="#{UserBean.user.groups}" rows="0">
													<div>
														<h:outputText value="Grant for #{ug.name}" styleClass="imj_admindataValueEntry"/>
													</div>
												</ui:repeat>
											</div>
										</div>
									</h:panelGroup>
								</h:form>
										
					
							</div> <!-- END CONTENT -->
							
						</h:panelGroup>
						
					</div> <!-- END LIST BODY -->	
					
				</div> <!-- END ADMIN LIST -->
					
			</div> <!-- END USER CONFIG -->
				
		</ui:fragment>	
		
	</ui:define>
		
</ui:composition>






