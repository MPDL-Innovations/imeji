<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:lic="http://java.sun.com/jsf/composite/components/license">
	
	<composite:interface componentType="StatusComponent">
		<composite:attribute name="browseButtonId"/>
		<composite:attribute name="collectionId"/>
		<composite:attribute name="updateButtonId"/>
		<composite:attribute name="dropElementId"/>
		<composite:attribute name="uploadId"/>
		<composite:attribute name="license"/>
	</composite:interface>
	
	<composite:implementation>
		<h:panelGroup id="licenseVariables">
			<h:inputHidden id="name" value="#{cc.attrs.license.name}"/>
			<h:inputHidden id="label" value="#{cc.attrs.license.label}"/>
			<h:inputHidden id="url" value="#{cc.attrs.license.url}"/>
		</h:panelGroup>
		<ui:remove><script src="#{Navigation.applicationUrl}resources/jquery/jquery-1.11.1.min.js"/>
        <script src="#{Navigation.applicationUrl}resources/jquery/ui/1.10.4/jquery-ui.min.js"/>
        <script src="#{Navigation.applicationUrl}resources/js/default.js"/></ui:remove>
		<script type="text/javascript" src="#{Navigation.applicationUrl}resources/plupload/2.1.2/js/plupload.full.min.js"></script>
		<script>
			var totalFiles = 0;
			var uploadedFiles = 0;
			var uploader = new plupload.Uploader({
				runtimes : 'html5,flash,silverlight,html4',
				browse_button : '#{cc.attrs.browseButtonId}',
				url : '#{Navigation.applicationUrl}uploadServlet?col=#{cc.attrs.collectionId}&amp;apiKey=#{SessionBean.user.apiKey}',
				max_file_size : '#{Configuration.uploadMaxFileSize}kb',
				multi_selection : true,
				dragdrop: true,
				drop_element: '#{cc.attrs.dropElementId}',
				multipart_params: {
					licenseName: document.getElementById('actionCollection:uploadDialog:uploadForm:uploader:name').value,
					licenseLabel:  document.getElementById('actionCollection:uploadDialog:uploadForm:uploader:label').value,
					licenseUrl:  document.getElementById('actionCollection:uploadDialog:uploadForm:uploader:url').value,
					},
				init: {	
					PostInit: function() {
						totalFiles = 0
						uploadedFiles = 0;			
					},				
					FilesAdded: function(up, files) {
						totalFiles =  files.length;
						closeDialog('uploadDialog');
						lockPage();
						$(".uploadPanel").show();
						addUploadStatusMessage(0,totalFiles);
						var licenseName = document.getElementById('actionCollection:uploadDialog:uploadForm:uploader:name').value;
						var licenseLabel = document.getElementById('actionCollection:uploadDialog:uploadForm:uploader:label').value;
						var licenseUrl = document.getElementById('actionCollection:uploadDialog:uploadForm:uploader:url').value;
						uploader.settings.multipart_params = { licenseName: licenseName, licenseLabel: licenseLabel, licenseUrl: licenseUrl};
						uploader.start();							
					},
					UploadProgress: function(up, file) {
						addUploadStatusMessage(uploadedFiles,totalFiles,file.name,file.percent);
					},
					UploadComplete: function(up, files) {
						document.getElementById('#{cc.attrs.updateButtonId}').click();
						addUploadStatusMessageDone(uploadedFiles);
						uploader.init();
					},
					Error: function(up, err) {
				    	addUploadStatusMessage(uploadedFiles,totalFiles);
				    	addUploadErrorMessage(err.file.name, err.response);
				    },
				    FileUploaded: function(up, file, info) {
				    	 uploadedFiles = uploadedFiles + 1;
				    	 addUploadStatusMessage(uploadedFiles,totalFiles);	
		            },
				}
			});
			uploader.init();
			closeSuccessMessage();
			function addUploadStatusMessage(uploaded, total, filename, percent){
				$(".uploadPanelContent").html('<pre>#{lbl.uploading} ' + uploaded + ' / ' + total + ' #{lbl.files}.</pre>');
				if(filename != null){
					$(".uploadPanelContent").html('<pre>#{lbl.uploading} ' + uploaded + ' / ' + total + ' #{lbl.files}. \n\n' +filename + '(' + percent + '%)</pre>');
				}
			}
			function addUploadStatusMessageDone(uploaded){
				$(".uploadPanel").hide();
				if(uploaded != '0'){
					document.getElementById('Header:imj_pageMessageArea').innerHTML += '<div id="uploadStatus" class="imj_message imj_messageSuccess" style="display=block;"><span class="fa fa-check" style="margin-right: 10px;"/>' + uploaded + ' #{lbl.files} #{lbl.uploaded}.<span class="imj_messageAreaCloseBtn"  onclick="this.parentElement.style.display=\'none\'; setTimeout(function() {$(this).fadeOut(1000); }, 2000);">x</span><span id="uploadStatusContent"></span></div>';
				}

			}
			function addUploadErrorMessage(filename, error){
				document.getElementById('Header:imj_pageMessageArea').innerHTML += '<div  class="imj_message imj_messageError"><span class="fa fa-exclamation" style="margin-right: 10px;"/><span class="imj_messageAreaCloseBtn" onclick="this.parentElement.style.display=\'none\';">x</span>'+ filename + ' #{lbl.not_uploaded}: ' + error +'</div>';
			}
			
			
		</script>
		
	</composite:implementation>
</html>