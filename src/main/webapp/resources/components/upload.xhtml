<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:lic="http://java.sun.com/jsf/composite/components/license">
	
	<composite:interface componentType="StatusComponent">
		<composite:attribute name="browseButtonId"/>
		<composite:attribute name="collectionId"/>
		<composite:attribute name="updateButtonId"/>
		<composite:attribute name="dropElementId"/>
	</composite:interface>
	
	<composite:implementation>
		<style>
			.uploadFileListEntry{
				line-height:normal;
				font-size: small;
			}
		</style>
		<script type="text/javascript" src="#{Navigation.applicationUrl}resources/plupload/2.1.2/js/plupload.full.min.js"></script>
				<script type="text/javascript">
					var totalFiles = 0
					var uploadedFiles = 0;
					var uploader = new plupload.Uploader({
						runtimes : 'html5,flash,silverlight,html4',
						browse_button : '#{cc.attrs.browseButtonId}',
						url : '#{Navigation.applicationUrl}uploadServlet?col=#{cc.attrs.collectionId}&amp;apiKey=#{SessionBean.user.apiKey}',
						max_file_size : '#{Configuration.uploadMaxFileSize}kb',
						multi_selection : true,
						dragdrop: true,
						drop_element: '#{cc.attrs.dropElementId}',
						init: {
							PostInit: function() {
								totalFiles = 0
								uploadedFiles = 0;			
							},				
							FilesAdded: function(up, files) {
								totalFiles =  files.length;
								addUploadStatusMessage(0,totalFiles);	
								uploader.start();							
							},
							UploadProgress: function(up, file) {
								addUploadStatusMessage(uploadedFiles,totalFiles,file.name,file.percent);
							},
							UploadComplete: function(up, files) {
								document.getElementById('#{cc.attrs.updateButtonId}').click();
								addUploadStatusMessageDone();
								uploader.init();
							},
							Error: function(up, err) {
								uploadedFiles = uploadedFiles + 1;
						    	addUploadStatusMessage(uploadedFiles,totalFiles);
						    	addUploadErrorMessage(err.file.name, err.response);
						    },
						    FileUploaded: function(up, file, info) {
						    	 uploadedFiles = uploadedFiles + 1;
						    	 addUploadStatusMessage(uploadedFiles,totalFiles);	
				            },
						}
					});
					uploader.init();
					function closeUploadMessageArea(){
						$("#closeUploadMessageArea").click(function(){
							$("##{cc.attrs.messageAreaId}").hide();
						});
					}
					
					function addUploadStatusMessage(uploaded, total, filename, percent){
						if(document.getElementById('uploadStatus') == null){
							document.getElementById('imj_pageMessageArea').innerHTML += '<div id="uploadStatus" class="imj_message"><span class="imj_messageAreaCloseBtn"  onclick="this.parentElement.style.display=\'none\';">x</span><span id="uploadStatusContent"></span></div>';
						}
						document.getElementById('uploadStatus').style.display='block';
						document.getElementById('uploadStatusContent').innerHTML =  '#{lbl.uploading} ' + uploaded + ' / ' + total + ' #{lbl.files}. ';
						if(filename != null){
							document.getElementById('uploadStatusContent').innerHTML += ' -  ' + filename + '(' + percent + '%)';
						}
					}
					function addUploadStatusMessageDone(){
						document.getElementById('uploadStatus').style.display='block';
						document.getElementById('uploadStatusContent').innerHTML +=  ' #{lbl.done}!';
					}
					function addUploadErrorMessage(filename, error){
						document.getElementById('imj_pageMessageArea').innerHTML += '<div  class="imj_message imj_messageError	"><span class="imj_messageAreaCloseBtn" onclick="this.parentElement.style.display=\'none\';">x</span>'+ filename + ' #{lbl.not_uploaded}: ' + error +'</div>';
					}
				</script>
	</composite:implementation>
</html>