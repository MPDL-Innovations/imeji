<ui:composition template="templates/template_site.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:list="http://java.sun.com/jsf/composite/components/list">
	
	<ui:param name="headline" value="#{lbl.singleUploadPageTitle}"/>
	<ui:param name="currentMainMenu" value="upload"/>
	
	
	<ui:define name="mainContent">
		<!-- Breadcrumb - History -->
		<ui:include src="./include/History.xhtml"/>
		
 		<!-- If User is not logged in -->
		<ui:fragment rendered="#{!Auth.loggedIn}">
			<h:panelGroup layout="block" styleClass="imj_pageMessageArea" rendered="#{!Auth.loggedIn}">
	        	<ui:include src="./include/LoginFormular.xhtml"/>
			</h:panelGroup>
		</ui:fragment>
		

		<h:panelGroup layout="block" id="imj_ajaxWrapper" rendered="#{Auth.loggedIn}">

			<h:panelGroup layout="block" styleClass="imj_upload">
				
				<div class="imj_headline">
					<h2>
						<h:outputText value="#{lbl.uploadFile}"/>
					</h2>
				</div>
				
				<h:form id="singleUpload">
					<h:panelGroup layout="block" id="selCols" styleClass="imj_inlineSelectionGroup">
						<span class="imj_selectionLabel">
							<h:outputText value="#{lbl.select_collection}"/>
						</span>
						<h:selectOneMenu id="collections" value="#{SingleUploadBean.selectedCollectionItem}" styleClass="imj_selectionBox">
							<f:selectItems value="#{SingleUploadBean.collectionItems}"/>
							<f:ajax event="change" execute="@this" render=":singleUpload:mdProfile" listener="#{SingleUploadBean.colChangeListener}"/>
						</h:selectOneMenu>
					</h:panelGroup>
					
					<div class="imj_fileUploadContainer imj_singleUpload">
						<div id="filelist" class="imj_uploadFilelist">Your browser doesn't have Flash, Silverlight or HTML5 support.</div>
		
						<div id="container" class="imj_submitPanel">
						    <button id="pickfiles" class="imj_submitButton">[Select files]</button>
						    <button id="uploadfiles" class="imj_submitButton">[Upload files]</button>
						</div>
					</div>
						
					
					<h:panelGroup id="techmetadata" layout="block" styleClass="imj_techdataList" rendered="#{SingleUploadBean.techMd.size()>0}">
						<div class="imj_listHeader"><h3 class="imj_sectionHeadline" style="white-space:nowrap;">#{SingleUploadBean.ingestImage.name}</h3></div>
						<div class="imj_listBody">
							<ui:repeat id="techMd" var="techMd" value="#{SingleUploadBean.techMd}">
								<h:outputText value="#{techMd}" styleClass="imj_techdataEntry"/>
							</ui:repeat>
						</div>
					</h:panelGroup>

					<h:panelGroup layout="block" id="mdProfile" styleClass="imj_metadataList">
						<h3 class="imj_sectionHeadline">#{lbl.metadata_profile}</h3>
						<ui:repeat id="smdb" var="smdb" value="#{SingleUploadBean.superMetadataBeans}" rows="0" varStatus="indexMetadata">	
								<!-- MetaDataList - edit panel container set -->
								<div class="imj_metadataSet">
									<div class="imj_metadataLabel">
										<h:outputText value="#{MetadataLabels.internationalizedLabels[smdb.statement.id]}"/>
										<span class="imj_invisible">: </span>
									</div>
									<div class="imj_metadataValue" style="margin-left: #{smdb.hierarchyLevel}em;">
										<!-- MetaDataInput -->
										<list:batchEditList_singleStatement itemBean="#{smdb}" itemStatement="#{smdb.statement}" itemLabelBean="#{MetadataLabels}" hideLabel="true" navBean="#{Navigation}" suggestBean="#{SuggestBean}"/>		
									</div>
								</div>
						</ui:repeat>
					</h:panelGroup>
					
					<div class="imj_submitPanel">
						<h:outputLink value="#{HistorySession.previousPage.completeUrlWithHistory}" styleClass="imj_cancelButton">
							<h:outputText value="#{lbl.cancel}" />
						</h:outputLink>
						<h:commandButton action="#{SingleUploadBean.save}" value="#{lbl.save}" styleClass="imj_submitButton" rendered="#{SingleUploadBean.readyFotUploading()}"/>
					</div>
					
					<ui:fragment rendered="#{SingleUploadBean.getfFile() != '' or not empty SingleUploadBean.getItem()}">
						<div class="imj_uploadMessageArea">
							<h2 class="imj_headline">
								<h:outputText value="#{lbl.info_lblMessageHeader}"/>
							</h2>
							<h:panelGroup layout="block" styleClass="imj_fileErrorMessageArea" rendered="#{SingleUploadBean.getfFile() != '' }">
								<h3 class="imj_sectionHeadline">
									<h:outputText value="#{msg.error_upload}:"/>
								</h3>
								<li class="imj_messageError">
									<h:outputText value="#{SingleUploadBean.getfFile()}"/>
								</li>
	
							</h:panelGroup>					
							<h:panelGroup layout="block" styleClass="imj_fileErrorMessageArea" rendered="#{not empty SingleUploadBean.getItem()}">
									<h3 class="imj_sectionHeadline">
										<h:outputText value="#{msg.success_upload}:" />
									</h3>
									<h:outputLink value="#{Navigation.collectionUrl}#{SingleUploadBean.extractIDFromURI(SingleUploadBean.getItem().collection)}/item/#{SingleUploadBean.getItem().idString}">
										<h:outputText value="#{SingleUploadBean.getItem().filename}"/>		
									</h:outputLink>
							</h:panelGroup>
						</div>
					</ui:fragment>
				</h:form>
			</h:panelGroup>
		</h:panelGroup>
	</ui:define>
	
	<ui:define name="additonalFooterScripts">
		<script type="text/javascript" src="#{Navigation.applicationUrl}resources/plupload/2.1.2/js/plupload.full.min.js"></script>
		
		<script type="text/javascript">
	
			var uploader = new plupload.Uploader({
				runtimes : 'html5,flash,silverlight,html4',
				browse_button : 'pickfiles', // you can pass in id...
				container: document.getElementById('container'), // ... or DOM Element itself
				url : location.pathname  + "?start=1",
				max_file_size : '#{Configuration.uploadMaxFileSize}kb',
				multi_selection : false,
				init: {
					PostInit: function() {
						document.getElementById('filelist').innerHTML = '';					
						document.getElementById('uploadfiles').onclick = function() {
							uploader.start();
						};
					},
					
					FilesAdded: function(up, files) {
						plupload.each(files, function(file) {
							if(up.files.length > 1)
							{
								up.removeFile(file);
							}
							
							document.getElementById('filelist').innerHTML = '<div id="' + file.id + '">' + file.name + ' (' + plupload.formatSize(file.size) + ')</div>';
						});
					},
					
					UploadProgress: function(up, file) {
						document.getElementById(file.id).getElementsByTagName('b')[0].innerHTML = '<span>' + file.percent + "%</span>";
					},
					 StateChanged: function(up) {
							// Called when the state of the queue is changed
							if( up.state == plupload.STOPPED)
								report();
		
					},
				}
			});
			
			uploader.init();
			function report(){
				window.location.href = location.pathname + "?done=1";
			}
		</script>
	</ui:define>

</ui:composition>